name: Deploy All Cloudflare Workers

on:
  push:
    branches:
      - claude/**  # All Claude branches
      - main
      - master
    paths:
      - 'cloudflare-agents/**'
      - 'cloudflare-workers/**'
      - 'pyswarm/**'
      - 'wrangler*.toml'
      - '.github/workflows/deploy-cloudflare-workers.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Cloudflare Workers

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd cloudflare-agents
          npm install

      - name: Detect changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            # cloudflare-agents/ workers (TypeScript)
            evolution:
              - 'cloudflare-agents/evolution-agent-simple.ts'
              - 'cloudflare-agents/wrangler.toml'
            news-sentiment:
              - 'cloudflare-agents/news-sentiment-agent.ts'
              - 'cloudflare-agents/wrangler-news-sentiment.toml'
            multi-exchange:
              - 'cloudflare-agents/multi-exchange-data-worker.ts'
              - 'cloudflare-agents/wrangler-multi-exchange.toml'
            solana-dex:
              - 'cloudflare-agents/solana-dex-worker.ts'
              - 'cloudflare-agents/wrangler-solana-dex.toml'
            sentiment-backfill:
              - 'cloudflare-agents/sentiment-backfill-worker.ts'
              - 'cloudflare-agents/wrangler-sentiment-backfill.toml'
            historical:
              - 'cloudflare-agents/historical-data-worker.ts'
              - 'cloudflare-agents/wrangler-historical.toml'
            historical-cron:
              - 'cloudflare-agents/historical-data-collection-cron.ts'
              - 'cloudflare-agents/wrangler-historical-collection-cron.toml'
            historical-queue-producer:
              - 'cloudflare-agents/historical-data-queue-producer.ts'
              - 'cloudflare-agents/wrangler-historical-queue-producer.toml'
            historical-queue-consumer:
              - 'cloudflare-agents/historical-data-queue-consumer.ts'
              - 'cloudflare-agents/wrangler-historical-queue-consumer.toml'
            python-historical:
              - 'pyswarm/Data_Import/historical_worker.py'
              - 'pyswarm/wrangler_historical_import.toml'
            realtime-cron:
              - 'cloudflare-agents/realtime-price-collection-cron.ts'
              - 'cloudflare-agents/wrangler-realtime-price-cron.toml'
            monitor:
              - 'cloudflare-agents/data-collection-monitor.ts'
              - 'cloudflare-agents/wrangler-monitor.toml'
            technical-indicators:
              - 'cloudflare-agents/technical-indicators-agent.ts'
              - 'cloudflare-agents/wrangler-technical-indicators.toml'
            collection-alerts:
              - 'cloudflare-agents/collection-alerts-agent.ts'
              - 'cloudflare-agents/wrangler-collection-alerts.toml'
            dashboards:
              - 'cloudflare-agents/dashboards-worker.ts'
              - 'cloudflare-agents/dashboards/**/*.html'
              - 'cloudflare-agents/wrangler-dashboards.toml'
            # cloudflare-workers/ workers (JavaScript)
            comprehensive-data:
              - 'cloudflare-workers/comprehensive-data-worker.js'
              - 'wrangler.toml'
            data-backfill:
              - 'cloudflare-workers/data-backfill-worker.js'
              - 'wrangler-data-ingestion.toml'
            # Schema changes
            schemas:
              - 'cloudflare-agents/**/*.sql'
              - 'cloudflare-d1-schema.sql'
            # Workflow changes - redeploy everything
            workflow:
              - '.github/workflows/deploy-cloudflare-workers.yml'

      # ===========================================
      # D1 Database Migrations (Schema Changes)
      # ===========================================

      - name: Apply D1 Database Migrations
        if: steps.filter.outputs.schemas == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: d1 execute coinswarm-evolution --remote --file=sentiment-data-schema.sql

      - name: Apply Technical Indicators Schema
        if: steps.filter.outputs.schemas == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: d1 execute coinswarm-evolution --remote --file=d1-schema-technical-indicators.sql

      - name: Apply Price Data Schema
        if: steps.filter.outputs.schemas == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: '.'
          wranglerVersion: "4.45.4"
          command: d1 execute coinswarm-evolution --remote --file=cloudflare-d1-schema.sql

      - name: Apply Advanced Sentiment Migrations
        if: steps.filter.outputs.schemas == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: d1 execute coinswarm-evolution --remote --file=sentiment-advanced-schema.sql

      - name: Apply Price Data Collection Schema
        if: steps.filter.outputs.schemas == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: d1 execute coinswarm-evolution --remote --file=price-data-schema.sql

      # ===========================================
      # cloudflare-agents/ Workers (TypeScript)
      # ===========================================

      - name: Deploy Evolution Agent
        if: steps.filter.outputs.evolution == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler.toml

      - name: Deploy News & Sentiment Agent
        if: steps.filter.outputs.news-sentiment == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-news-sentiment.toml

      - name: Deploy Multi-Exchange Data Worker
        if: steps.filter.outputs.multi-exchange == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-multi-exchange.toml

      - name: Deploy Solana DEX Worker
        if: steps.filter.outputs.solana-dex == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-solana-dex.toml

      - name: Deploy Sentiment Backfill Worker
        if: steps.filter.outputs.sentiment-backfill == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-sentiment-backfill.toml

      - name: Create KV Namespace for Historical Data
        if: steps.filter.outputs.historical == 'true' || steps.filter.outputs.workflow == 'true'
        id: create-kv
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: kv namespace create HISTORICAL_PRICES

      - name: Deploy Historical Data Worker
        if: steps.filter.outputs.historical == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-historical.toml

      - name: Deploy Historical Data Collection Cron
        if: steps.filter.outputs.historical-cron == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-historical-collection-cron.toml
          secrets: |
            COINGECKO
            CRYPTOCOMPARE_API_KEY
        env:
          COINGECKO: ${{ secrets.COINGECKO }}
          CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}

      - name: Create Historical Data Queue
        if: steps.filter.outputs.historical-queue-consumer == 'true' || steps.filter.outputs.historical-queue-producer == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: queues create historical-data-queue

      - name: Create Dead Letter Queue
        if: steps.filter.outputs.historical-queue-consumer == 'true' || steps.filter.outputs.historical-queue-producer == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: queues create historical-data-dlq

      - name: Deploy Historical Data Queue Consumer
        if: steps.filter.outputs.historical-queue-consumer == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-historical-queue-consumer.toml

      - name: Deploy Historical Data Queue Producer
        if: steps.filter.outputs.historical-queue-producer == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-historical-queue-producer.toml
          secrets: |
            CRYPTOCOMPARE_API_KEY
        env:
          CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}

      - name: Deploy Python Historical Worker
        if: steps.filter.outputs.python-historical == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'pyswarm'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler_historical_import.toml
          secrets: |
            CRYPTOCOMPARE_API_KEY
        env:
          CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}

      - name: Deploy Real-Time Price Collection Cron
        if: steps.filter.outputs.realtime-cron == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-realtime-price-cron.toml
          secrets: |
            COINGECKO
            CRYPTOCOMPARE_API_KEY
        env:
          COINGECKO: ${{ secrets.COINGECKO }}
          CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}

      - name: Deploy Data Collection Monitor Dashboard
        if: steps.filter.outputs.monitor == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-monitor.toml

      - name: Deploy Technical Indicators Agent
        if: steps.filter.outputs.technical-indicators == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-technical-indicators.toml

      - name: Deploy Collection Alerts Agent
        if: steps.filter.outputs.collection-alerts == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-collection-alerts.toml

      - name: Deploy Dashboards
        if: steps.filter.outputs.dashboards == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'cloudflare-agents'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-dashboards.toml

      # ===========================================
      # cloudflare-workers/ Workers (JavaScript)
      # ===========================================

      - name: Deploy Comprehensive Data Worker
        if: steps.filter.outputs.comprehensive-data == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: '.'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler.toml

      - name: Deploy Data Backfill Worker
        if: steps.filter.outputs.data-backfill == 'true' || steps.filter.outputs.workflow == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: '.'
          wranglerVersion: "4.45.4"
          command: deploy --config wrangler-data-ingestion.toml

      # ===========================================
      # Deployment Summary
      # ===========================================

      - name: Deployment Complete
        run: |
          echo "‚úÖ Worker deployment workflow completed!"
          echo ""
          echo "üìä Conditional Deployment Summary:"
          echo "- Only workers with file changes were deployed"
          echo "- Reduced deployment time by skipping unchanged workers"
          echo "- Check individual step logs above for deployment details"
          echo ""
          echo "üîç View deployed workers at: https://dash.cloudflare.com"
          echo "üìà Total workers managed: 17 (14 TypeScript + 2 JavaScript + 1 Python)"
          echo "   - 14 TypeScript workers (cloudflare-agents/)"
          echo "   - 2 JavaScript workers (cloudflare-workers/)"
          echo "   - 1 Python worker (pyswarm/)"
          echo "   - Queue-based system (producer + consumer)"
          echo "   - Static dashboards worker included"
